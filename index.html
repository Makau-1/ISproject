<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISproject - Secure User Management</title>
    <link rel="stylesheet" href="style.css">
    <meta name="description" content="Secure user management system built with Node.js, Express, and PostgreSQL">
    <style>
        /* Embedded styles for immediate visual feedback */
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            display: block;
            margin-top: 0.25rem;
        }
        
        .password-strength {
            height: 5px;
            border-radius: 3px;
            margin-top: 0.5rem;
            transition: all 0.3s;
        }
        
        .password-strength.weak {
            background: linear-gradient(to right, #dc3545 0%, #dc3545 33%, #e9ecef 33%);
        }
        
        .password-strength.medium {
            background: linear-gradient(to right, #ffc107 0%, #ffc107 66%, #e9ecef 66%);
        }
        
        .password-strength.strong {
            background: linear-gradient(to right, #28a745 0%, #28a745 100%);
        }
        
        .requirements-card li {
            transition: color 0.3s;
        }
        
        .requirements-card li.valid {
            color: #28a745;
        }
        
        .requirements-card li.invalid {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîê ISproject User Management</h1>
            <p>Secure full-stack application with Node.js + Express + PostgreSQL | Password Hashing & Input Validation</p>
        </header>

        <div class="main-content">
            <!-- User Registration Form -->
            <section class="form-section">
                <h2>üìù Register New User</h2>
                <form id="userForm" novalidate>
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            required 
                            minlength="3"
                            maxlength="50"
                            pattern="[a-zA-Z][a-zA-Z0-9_]*"
                            placeholder="Enter username (3-50 characters, letters/numbers/underscores)"
                            title="Username must start with a letter and contain only letters, numbers, and underscores"
                        >
                        <span id="usernameError" class="error-message"></span>
                        <div class="input-hint">
                            üí° Must start with a letter, 3-50 characters, letters/numbers/underscores only
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            required
                            placeholder="Enter email address"
                            title="Enter a valid email address"
                        >
                        <span id="emailError" class="error-message"></span>
                        <div class="input-hint">
                            üìß Must be a valid email format
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            required 
                            minlength="8"
                            maxlength="100"
                            placeholder="Enter strong password (min 8 characters)"
                            title="Password must include uppercase, lowercase, number, and special character"
                        >
                        <span id="passwordError" class="error-message"></span>
                        <div id="passwordStrength" class="password-strength"></div>
                        <div class="input-hint">
                            üîí Must include: uppercase, lowercase, number, special character, min 8 chars
                        </div>
                    </div>
                    
                    <button type="submit" id="submitBtn">
                        <span class="btn-text">üöÄ Register User</span>
                        <span class="btn-loading" style="display: none;">‚è≥ Processing...</span>
                    </button>
                </form>

                <!-- Password Requirements Summary -->
                <div class="requirements-card">
                    <h3>üìã Password Requirements:</h3>
                    <ul>
                        <li id="req-length">‚èπ At least 8 characters</li>
                        <li id="req-lowercase">‚èπ One lowercase letter (a-z)</li>
                        <li id="req-uppercase">‚èπ One uppercase letter (A-Z)</li>
                        <li id="req-number">‚èπ One number (0-9)</li>
                        <li id="req-special">‚èπ One special character (!@#$% etc.)</li>
                    </ul>
                </div>
            </section>

            <!-- Users Display Section -->
            <section class="users-section">
                <div class="section-header">
                    <h2>üë• Registered Users</h2>
                    <div class="users-controls">
                        <button id="loadUsers" class="load-btn">
                            <span class="btn-text">üîÑ Load Users</span>
                            <span class="btn-loading" style="display: none;">‚è≥ Loading...</span>
                        </button>
                        <span id="usersCount" class="users-count">0 users</span>
                    </div>
                </div>
                
                <div id="usersList" class="users-list">
                    <div class="no-users">
                        <p>üì≠ No users registered yet</p>
                        <p class="hint">Register a user to see them here!</p>
                    </div>
                </div>

                <!-- Users Statistics -->
                <div class="stats-card">
                    <h3>üìä Quick Stats</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-number" id="totalUsers">0</span>
                            <span class="stat-label">Total Users</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="todayUsers">0</span>
                            <span class="stat-label">Registered Today</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Status Messages -->
        <div id="message" class="message hidden"></div>

        <!-- Footer -->
        <footer class="app-footer">
            <div class="footer-content">
                <p>üõ° <strong>ISproject</strong> - Secure Cloud Deployment on Azure | Built with Node.js + Express + PostgreSQL</p>
                <p class="tech-stack">üîß Technologies: HTML5, CSS3, JavaScript, BCrypt Password Hashing, Sequelize ORM, Input Validation, HTTPS, CORS</p>
                <p class="deployment-info">‚òÅ Deployed on: Azure App Service | Database: Azure PostgreSQL | Domain: makaualex.space</p>
            </div>
        </footer>
    </div>

    <script>
        // Real-time validation and user management
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const userForm = document.getElementById('userForm');
        const usernameError = document.getElementById('usernameError');
        const emailError = document.getElementById('emailError');
        const passwordError = document.getElementById('passwordError');
        const passwordStrength = document.getElementById('passwordStrength');
        const messageDiv = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const loadUsersBtn = document.getElementById('loadUsers');

        // Password requirements elements
        const reqLength = document.getElementById('req-length');
        const reqLowercase = document.getElementById('req-lowercase');
        const reqUppercase = document.getElementById('req-uppercase');
        const reqNumber = document.getElementById('req-number');
        const reqSpecial = document.getElementById('req-special');

        // Real-time username validation
        usernameInput.addEventListener('input', function() {
            const username = this.value;
            usernameError.textContent = '';
            usernameError.style.color = '#dc3545';
            
            if (username.length > 0) {
                if (username.length < 3) {
                    usernameError.textContent = '‚ùå Username must be at least 3 characters';
                } else if (username.length > 50) {
                    usernameError.textContent = '‚ùå Username must not exceed 50 characters';
                } else if (!/^[a-zA-Z]/.test(username)) {
                    usernameError.textContent = '‚ùå Username must start with a letter';
                } else if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(username)) {
                    usernameError.textContent = '‚ùå Only letters, numbers, and underscores allowed';
                } else {
                    usernameError.textContent = '‚úÖ Valid username';
                    usernameError.style.color = '#28a745';
                }
            }
        });

        // Real-time email validation
        emailInput.addEventListener('input', function() {
            const email = this.value;
            emailError.textContent = '';
            emailError.style.color = '#dc3545';
            
            if (email.length > 0) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailError.textContent = '‚ùå Invalid email format';
                } else {
                    emailError.textContent = '‚úÖ Valid email';
                    emailError.style.color = '#28a745';
                }
            }
        });

        // Real-time password validation with strength indicator
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            passwordError.textContent = '';
            passwordError.style.color = '#dc3545';
            
            if (password.length === 0) {
                passwordStrength.className = 'password-strength';
                passwordStrength.style.background = '#e9ecef';
                resetRequirements();
                return;
            }

            // Check requirements
            const hasLength = password.length >= 8;
            const hasLowercase = /[a-z]/.test(password);
            const hasUppercase = /[A-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

            // Update requirement indicators
            updateRequirement(reqLength, hasLength);
            updateRequirement(reqLowercase, hasLowercase);
            updateRequirement(reqUppercase, hasUppercase);
            updateRequirement(reqNumber, hasNumber);
            updateRequirement(reqSpecial, hasSpecial);

            // Calculate strength
            const metRequirements = [hasLength, hasLowercase, hasUppercase, hasNumber, hasSpecial].filter(Boolean).length;
            
            if (metRequirements <= 2) {
                passwordStrength.className = 'password-strength weak';
            } else if (metRequirements <= 4) {
                passwordStrength.className = 'password-strength medium';
            } else {
                passwordStrength.className = 'password-strength strong';
            }

            // Show error if not all requirements met
            if (!hasLength || !hasLowercase || !hasUppercase || !hasNumber || !hasSpecial) {
                passwordError.textContent = '‚ö† Password does not meet all requirements';
            } else {
                passwordError.textContent = '‚úÖ Strong password';
                passwordError.style.color = '#28a745';
            }
        });

        function updateRequirement(element, isValid) {
            if (isValid) {
                element.className = 'valid';
                element.innerHTML = element.innerHTML.replace(/‚ùå|‚èπ|‚úÖ/, '‚úÖ');
            } else {
                element.className = 'invalid';
                element.innerHTML = element.innerHTML.replace(/‚ùå|‚èπ|‚úÖ/, '‚ùå');
            }
        }

        function resetRequirements() {
            [reqLength, reqLowercase, reqUppercase, reqNumber, reqSpecial].forEach(el => {
                el.className = '';
                el.innerHTML = el.innerHTML.replace(/‚ùå|‚úÖ/, '‚èπ');
            });
        }

        // Form submission with validation
        userForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = usernameInput.value.trim();
            const email = emailInput.value.trim();
            const password = passwordInput.value;

            // Client-side validation
            if (!validateUsername(username)) return;
            if (!validateEmail(email)) return;
            if (!validatePassword(password)) return;

            // Show loading state
            toggleLoadingState(submitBtn, true);

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage('‚úÖ ' + data.message + ' Password securely hashed!', 'success');
                    userForm.reset();
                    passwordStrength.className = 'password-strength';
                    passwordStrength.style.background = '#e9ecef';
                    resetRequirements();
                    usernameError.textContent = '';
                    emailError.textContent = '';
                    passwordError.textContent = '';
                    loadUsers();
                } else {
                    showMessage('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Network error: ' + error.message, 'error');
            } finally {
                toggleLoadingState(submitBtn, false);
            }
        });

        // Load users
        loadUsersBtn.addEventListener('click', loadUsers);

        async function loadUsers() {
            toggleLoadingState(loadUsersBtn, true);
            
            try {
                const response = await fetch('/api/users');
                const data = await response.json();

                const usersList = document.getElementById('usersList');
                const usersCount = document.getElementById('usersCount');
                const totalUsers = document.getElementById('totalUsers');
                const todayUsers = document.getElementById('todayUsers');

                // Handle response format
                const users = data.users || data;

                if (!users || users.length === 0) {
                    usersList.innerHTML = `
                        <div class="no-users">
                            <p>üì≠ No users registered yet</p>
                            <p class="hint">Register a user to see them here!</p>
                        </div>
                    `;
                    usersCount.textContent = '0 users';
                    totalUsers.textContent = '0';
                    todayUsers.textContent = '0';
                } else {
                    usersList.innerHTML = users.map(user => `
                        <div class="user-card">
                            <div class="user-info">
                                <div class="user-avatar">üë§</div>
                                <div class="user-details">
                                    <h4 class="user-name">${escapeHtml(user.username)}</h4>
                                    <p class="user-meta">
                                        <span>üÜî ID: ${user.id}</span> | 
                                        <span>üìß ${escapeHtml(user.email)}</span> |
                                        <span>üìÖ ${formatDate(user.createdAt || user.created_at)}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="user-badge">üîí BCrypt Hashed</div>
                        </div>
                    `).join('');

                    usersCount.textContent = `${users.length} user${users.length !== 1 ? 's' : ''}`;
                    totalUsers.textContent = users.length;

                    // Calculate today's registrations
                    const today = new Date().toDateString();
                    const todayCount = users.filter(user => {
                        const createdDate = user.createdAt || user.created_at;
                        return createdDate && new Date(createdDate).toDateString() === today;
                    }).length;
                    todayUsers.textContent = todayCount;
                }
            } catch (error) {
                showMessage('‚ùå Error loading users: ' + error.message, 'error');
            } finally {
                toggleLoadingState(loadUsersBtn, false);
            }
        }

        // Validation functions
        function validateUsername(username) {
            if (!username || username.length < 3 || username.length > 50) {
                showMessage('‚ùå Username must be 3-50 characters long', 'error');
                return false;
            }
            if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(username)) {
                showMessage('‚ùå Username must start with a letter and contain only letters, numbers, and underscores', 'error');
                return false;
            }
            return true;
        }

        function validateEmail(email) {
            if (!email) {
                showMessage('‚ùå Email is required', 'error');
                return false;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('‚ùå Please enter a valid email address', 'error');
                return false;
            }
            return true;
        }

        function validatePassword(password) {
            if (password.length < 8) {
                showMessage('‚ùå Password must be at least 8 characters long', 'error');
                return false;
            }
            if (!/[a-z]/.test(password)) {
                showMessage('‚ùå Password must contain at least one lowercase letter', 'error');
                return false;
            }
            if (!/[A-Z]/.test(password)) {
                showMessage('‚ùå Password must contain at least one uppercase letter', 'error');
                return false;
            }
            if (!/[0-9]/.test(password)) {
                showMessage('‚ùå Password must contain at least one number', 'error');
                return false;
            }
            if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
                showMessage('‚ùå Password must contain at least one special character', 'error');
                return false;
            }
            return true;
        }

        // Utility functions
        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        function toggleLoadingState(button, isLoading) {
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            if (isLoading) {
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                button.disabled = true;
            } else {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                button.disabled = false;
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Load users on page load
        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>